{% extends "base.html" %}
{% set active_page = 'verify' %}
{% block title %}Verify Certificate – CertifyMe{% endblock %}

{% block main %}
<div class="container-xl" style="max-width: 1150px;">
  <div class="app-card-shell">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <div class="page-kicker mb-1">Verification</div>
        <h1 class="page-title mb-1">Verify a certificate</h1>
        <p class="page-subtitle mb-0">
          Enter a certificate ID, public link, or file hash to verify authenticity.
        </p>
      </div>
    </div>

    <div class="row g-3 align-items-stretch">
      <!-- Left: form -->
      <div class="col-lg-5">
        <div class="card-soft h-100 d-flex flex-column justify-content-between">
          <form method="post" action="{{ url_for('verify_certificate') }}">
            <div class="field-label mb-1">Certificate ID / URL / hash</div>
            <input
              type="text"
              name="query"
              class="form-control mb-3"
              placeholder="e.g. CFM-2024-ABCD1234"
              value="{{ result.certificate_id if result else request.args.get('code','') }}"
              autocomplete="off"
            >

            <button type="submit" class="btn btn-primary-pill w-100">
              Verify certificate
            </button>
          </form>

          <p class="small-muted mt-3 mb-0">
            Verification is read-only and auditable. We never change issued certificates here.
          </p>
        </div>
      </div>

      <!-- Right: result card -->
      <div class="col-lg-7">
        <div class="card-soft h-100">

          {% if result is not defined or result is none %}
            <div class="small-muted mb-1">Status</div>
            <h5 class="mb-1">Awaiting verification</h5>
            <p class="small-muted mb-0">
              Paste a certificate ID on the left and click <strong>Verify certificate</strong> to see the result here.
            </p>

          {% elif result.valid %}
            <!-- Genuine certificate -->
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div class="d-flex align-items-center gap-2">
                <span class="status-pill status-pill--ok">
                  <span class="status-dot status-dot--ok"></span>
                  Certificate verified
                </span>
              </div>
              <div class="small-muted text-end">
                ID:
                <span class="chip chip--accent">{{ result.certificate_id }}</span><br>
                Issued: {{ result.issued_at }}
              </div>
            </div>

            <hr class="my-2" style="border-color: rgba(255,255,255,0.08);">

            <div class="mb-2">
              <div class="small-muted text-uppercase mb-1" style="letter-spacing:0.16em;">Student</div>
              <div class="fw-semibold">{{ result.student_name }}</div>
              <div class="small-muted">{{ result.course }}</div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-sm-6">
                <div class="field-label">Issued by</div>
                <div class="small">{{ result.teacher_name }}</div>
                <div class="small-muted">{{ result.institute_name }}</div>
              </div>
              <div class="col-sm-3">
                <div class="field-label">Status</div>
                <span class="chip chip--accent">Active • Genuine</span>
              </div>
              <div class="col-sm-3">
                <div class="field-label">Score / Grade</div>
                <div class="small-muted">
                  {{ result.score if result.score else "Not specified" }}
                </div>
              </div>
            </div>

            <div class="mt-3 small-muted">
              Integrity checks:
              <ul class="mb-0">
                <li>File hash match: {{ '✅' if result.hash_ok else '❌' }}</li>
                <li>HMAC signature valid: {{ '✅' if result.sig_ok else '❌' }}</li>
              </ul>
            </div>

          {% else %}
            <!-- Invalid / tampered / not found -->
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div class="status-pill status-pill--pending">
                <span class="status-dot status-dot--pending"></span>
                Verification failed
              </div>
              <div class="small-muted text-end">
                Entered ID:
                <span class="chip">{{ result.certificate_id }}</span>
              </div>
            </div>

            <hr class="my-2" style="border-color: rgba(255,255,255,0.08);">

            {% if result.student_name %}
              <p class="small-muted mb-2">
                A record was found for this ID, but integrity checks failed.
              </p>
              <ul class="small-muted mb-2">
                <li>File hash match: {{ '✅' if result.hash_ok else '❌ mismatch' }}</li>
                <li>HMAC signature valid: {{ '✅' if result.sig_ok else '❌ invalid or missing' }}</li>
              </ul>
              <p class="small text-danger mb-0">
                This certificate appears <strong>TAMPERED or INVALID</strong>. Do not accept it as genuine.
              </p>
            {% else %}
              <p class="small-muted mb-0">
                No certificate was found for this ID. Please check for typos, or ask the issuer
                to resend the correct verification link.
              </p>
            {% endif %}

          {% endif %}

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
