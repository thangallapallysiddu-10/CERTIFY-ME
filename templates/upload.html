{% extends "base.html" %}
{% set active_page = 'teacher' %}
{% block title %}Issue Certificate – CertifyMe{% endblock %}

{% block head_extra %}
<style>
  .student-suggest-wrap {
    position: relative;
  }

  .student-suggest-list {
    position: absolute;
    z-index: 50;
    left: 0;
    right: 0;
    top: 100%;
    margin-top: 4px;
    border-radius: 12px;
    background: rgba(0,0,0,0.96);
    border: 1px solid rgba(255,255,255,0.14);
    box-shadow: 0 18px 40px rgba(0,0,0,0.9);
    max-height: 210px;
    overflow-y: auto;
  }

  .student-suggest-item {
    width: 100%;
    text-align: left;
    padding: 6px 10px;
    font-size: 0.84rem;
    border: none;
    background: transparent;
    color: #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .student-suggest-item span.email {
    font-size: 0.76rem;
    color: #9ca3af;
  }

  .student-suggest-item:hover {
    background: rgba(255,255,255,0.06);
  }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-center">
  <div class="w-100" style="max-width: 760px;">

    <!-- Header -->
    <div class="mb-3">
      <div class="page-kicker mb-1">Issue certificate</div>
      <h1 class="page-title mb-1">Create a new verifiable certificate</h1>
      <p class="page-subtitle mb-0">
        Start typing a registered student’s name to auto-fill their details, then upload
        the certificate file. CertifyMe will generate a signed verification code for you.
      </p>
    </div>

    <div class="card-soft">

      {# SUCCESS STATE #}
      {% if code %}
        <div class="mb-3">
          <div class="small-muted mb-1 text-uppercase" style="letter-spacing:0.16em;font-size:0.7rem;">
            Certificate issued
          </div>
          <h2 class="h5 mb-2">You’ve issued a new certificate.</h2>
          <p class="small-muted mb-0">
            Share this verification code with the student, or send them the public link.
            Anyone can paste it into the verify page to check authenticity.
          </p>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-7">
            <div class="card-soft">
              <div class="field-label mb-1">Verification code</div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="chip chip--accent code-chip mb-1">
                  {{ code }}
                </span>
                <button
                  type="button"
                  class="btn btn-ghost-pill btn-sm mb-1"
                  onclick="navigator.clipboard && navigator.clipboard.writeText('{{ code }}')"
                >
                  Copy code
                </button>
              </div>

              <div class="small-muted mt-2">
                Anyone can verify this at
                <a href="{{ url_for('verify_certificate', code=code) }}" target="_blank" rel="noopener noreferrer">
                  the public verify page
                </a>.
              </div>
            </div>
          </div>

          <div class="col-md-5">
            <div class="card-soft h-100 d-flex flex-column justify-content-between">
              <div>
                <div class="field-label mb-1">File stored as</div>
                <div class="small-muted">
                  {{ filename or "Uploaded file" }}
                </div>
              </div>

              {% if qr %}
                <div class="mt-2">
                  <div class="field-label mb-1">QR for this certificate</div>
                  <img
                    src="{{ url_for('static', filename='qrcodes/' ~ qr) }}"
                    alt="QR code"
                    style="max-width: 140px; border-radius: 12px; background:#000;"
                  >
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-ghost-pill">
            Back to dashboard
          </a>
          <a href="{{ url_for('upload') }}" class="btn btn-primary-pill">
            Issue another certificate
          </a>
        </div>

      {% else %}

      {# FORM STATE #}
      <form method="post" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="mb-3 student-suggest-wrap">
              <label class="field-label">Student name</label>
              <input
                type="text"
                name="student_name"
                id="studentNameInput"
                class="form-control"
                placeholder="Start typing to search..."
                autocomplete="off"
                required
              >
              <div id="studentSuggestList" class="student-suggest-list d-none"></div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label class="field-label">Student email</label>
              <input
                type="email"
                name="student_email"
                id="studentEmailInput"
                class="form-control"
                placeholder="student@example.com"
                required
              >
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="field-label">Description</label>
          <input
            type="text"
            name="description"
            class="form-control"
            placeholder="Course / event / achievement (optional)"
          >
        </div>

        <div class="mb-3">
          <label class="field-label">Certificate file</label>

          <div
            class="card-soft"
            style="background: rgba(0,0,0,0.8); border-style:dashed; border-color:rgba(255,255,255,0.18);"
          >
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
              <div>
                <div class="small-muted mb-1">
                  Upload a PDF or image (PNG / JPG / JPEG)
                </div>
                <div class="small-muted">
                  The file will be hashed (SHA-256) and signed before being stored.
                </div>
              </div>
              <div>
                <input
                  type="file"
                  name="file"
                  class="form-control"
                  accept=".pdf,.png,.jpg,.jpeg"
                  required
                >
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
          <div class="small-muted">
            By issuing, you create a cryptographically signed record in the CertifyMe database.
          </div>
          <button type="submit" class="btn btn-primary-pill">
            Issue certificate
          </button>
        </div>
      </form>

      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    const nameInput = document.getElementById('studentNameInput');
    const emailInput = document.getElementById('studentEmailInput');
    const list = document.getElementById('studentSuggestList');
    if (!nameInput || !list) return;

    let lastQuery = '';
    let fetchTimeout = null;

    function hideList() {
      list.classList.add('d-none');
      list.innerHTML = '';
    }

    function showSuggestions(items) {
      list.innerHTML = '';
      if (!items || !items.length) {
        hideList();
        return;
      }
      items.forEach(function (item) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'student-suggest-item';
        btn.innerHTML =
          '<span>' + item.name + '</span>' +
          '<span class="email">' + item.email + '</span>';
        btn.addEventListener('click', function () {
          nameInput.value = item.name;
          emailInput.value = item.email;
          hideList();
        });
        list.appendChild(btn);
      });
      list.classList.remove('d-none');
    }

    nameInput.addEventListener('input', function () {
      const q = nameInput.value.trim();
      if (q.length < 2) {
        hideList();
        return;
      }
      lastQuery = q;
      if (fetchTimeout) clearTimeout(fetchTimeout);
      fetchTimeout = setTimeout(function () {
        fetch('/api/student-search?q=' + encodeURIComponent(lastQuery))
          .then(function (res) { return res.json(); })
          .then(function (data) {
            // Only show if query hasn't changed
            if (nameInput.value.trim() === lastQuery) {
              showSuggestions(data);
            }
          })
          .catch(function () {
            hideList();
          });
      }, 200); // small debounce
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function (e) {
      if (!list.contains(e.target) && e.target !== nameInput) {
        hideList();
      }
    });
  })();
</script>
{% endblock %}
